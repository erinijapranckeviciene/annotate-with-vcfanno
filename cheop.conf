# annotate by vcfanno using identifier mapping
# GnomAD exome and genome annotations are aggregated to compute combined values
# GnomAD v.2.1.1 in Gnomad genome the South Asian population is added to Other
#
# Formula to integrate frequencies and to compute popmax: credits to Ryan Potter, CHEO.
#
#  AFGenomes+Exomes = ACGenomes+Exomes/ANGenomes+Exomes
#
# …we had to add the genome and exome numbers and then calculate the AF from that:
#
#                AFGenomes+Exomes = (ACGenomes + ACExomes)/(ANGenomes + ANExomes)
#
# So for each sub-population (AFR, ASJ, AMR, EAS, FIN, NFE, SAS, OTH), this AFGenomes+Exomes was calculated as above.
#
# Next, the AF_POPMAX was found by determining the largest of these values across the different sub-populations.  
# When the AC is reported in terms of the minor allele, the value is typically small, or at least <50% and there is no further action.  
# However, if the AC is reported in terms of the major allele, the value is large, and in the case of a refseq error, could potentially be 0.9991%.  
# To avoid missing these cases (as we want them flagged as rare variants), there is a further formula that actually finds the “POPMIN” when the POPMAX is >50%. 
#
#
# We add EXON name of interest  annotations here and also explicitly include gene ENTREZID of the EXON
#
##  EXONS from the bed file 
##  All used annotations have cheo_ prefix to distinguish from other annotations
[[annotation]]
file="variation/Exons-chr22-AgilentCREv2.bed.gz"
columns = [ 4, 6, 7]
names = [ "cheo_EXON", "cheo_ENTREZID", "cheo_GENENAME"]
ops = ["uniq", "uniq" , "uniq"]

## MIM number from OMIM
[[postannotation]]
fields=["cheo_ENTREZID"]
op="lua:EntrezIDToMim(cheo_ENTREZID)"
name="cheo_MIM"
type="Integer"

## OMIM syndromes annotation
[[postannotation]]
fields=["cheo_ENTREZID"]
op="lua:OMIMp(cheo_ENTREZID)"
name="cheo_OMIMp"
type="String"

## Ensembl Gene ID
##[[postannotation]]
##fields=["cheo_ENTREZID"]
##op="lua:EntrezIDToEnsembl(cheo_ENTREZID)"
##name="cheo_ENSG"
##type="String"

## Gene Description from NCBI/Gene gene_info.gz
[[postannotation]]
fields=["cheo_ENTREZID"]
op="lua:EntrezIDToGeneDescription(cheo_ENTREZID)"
name="cheo_GeneDescription"
type="String"

## ORPHANET list of disorders
[[postannotation]]
fields=["cheo_ENTREZID"]
op="lua:EntrezIDToOrpha(cheo_ENTREZID)"
name="cheo_ORPHA"
type="String"

## Gnomad OE Lof annotations
[[postannotation]]
fields=["cheo_ENTREZID"]
op="lua:EntrezIDToGnomadLof(cheo_ENTREZID)"
name="cheo_GnomadLof"
type="String"


############################################################
# Gnomad genome
[[annotation]]
file="variation/gnomad_genome.vcf.gz"
fields=["AF","AF_afr","AF_amr","AF_asj","AF_eas","AF_fin","AF_nfe","AF_oth","AC","AC_afr","AC_amr","AC_asj","AC_eas","AC_fin","AC_nfe","AC_oth","AN","AN_afr","AN_amr","AN_asj","AN_eas","AN_fin","AN_nfe","AN_oth"]
names=["gnomADg_AF","gnomADg_AF_AFR","gnomADg_AF_AMR","gnomADg_AF_ASJ","gnomADg_AF_EAS","gnomADg_AF_FIN","gnomADg_AF_NFE","gnomADg_AF_OTH","gnomADg_AC","gnomADg_AC_AFR","gnomADg_AC_AMR","gnomADg_AC_ASJ","gnomADg_AC_EAS","gnomADg_AC_FIN","gnomADg_AC_NFE","gnomADg_AC_OTH","gnomADg_AN","gnomADg_AN_AFR","gnomADg_AN_AMR","gnomADg_AN_ASJ","gnomADg_AN_EAS","gnomADg_AN_FIN","gnomADg_AN_NFE","gnomADg_AN_OTH"]
ops=["self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self"]


# Gnomad exome
[[annotation]]
file="variation/gnomad_exome.vcf.gz"
fields=["AF","AF_afr","AF_amr","AF_asj","AF_eas","AF_fin","AF_nfe","AF_oth","AF_sas","AC","AC_afr","AC_amr","AC_asj","AC_eas","AC_fin","AC_nfe","AC_oth","AC_sas","AN","AN_afr","AN_amr","AN_asj","AN_eas","AN_fin","AN_nfe","AN_oth","AN_sas"]
names=["gnomADe_AF","gnomADe_AF_AFR","gnomADe_AF_AMR","gnomADe_AF_ASJ","gnomADe_AF_EAS","gnomADe_AF_FIN","gnomADe_AF_NFE","gnomADe_AF_OTH","gnomADe_AF_SAS","gnomADe_AC","gnomADe_AC_AFR","gnomADe_AC_AMR","gnomADe_AC_ASJ","gnomADe_AC_EAS","gnomADe_AC_FIN","gnomADe_AC_NFE","gnomADe_AC_OTH","gnomADe_AC_SAS","gnomADe_AN","gnomADe_AN_AFR","gnomADe_AN_AMR","gnomADe_AN_ASJ","gnomADe_AN_EAS","gnomADe_AN_FIN","gnomADe_AN_NFE","gnomADe_AN_OTH","gnomADe_AN_SAS"]
ops=["self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self","self"]

##########################################################
## GENERAL COMBINED
#########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC", "gnomADg_AC"]
name="cheo_AC_TOTAL"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN", "gnomADg_AN"]
name="cheo_AN_TOTAL"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["cheo_AC_TOTAL", "cheo_AN_TOTAL"]
name="cheo_AF_TOTAL"
op="div2"
type="Float"

########################################################
## POPULATIONS COMBINED
########################################################
## African
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_AFR", "gnomADg_AC_AFR"]
name="AC_AFR"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_AFR", "gnomADg_AN_AFR"]
name="AN_AFR"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_AFR", "AN_AFR"]
name="cheo_AF_AFR"
op="div2"
type="Float"

########################################################
## European (non-Finnish)
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_NFE", "gnomADg_AC_NFE"]
name="AC_NFE"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_NFE", "gnomADg_AN_NFE"]
name="AN_NFE"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_NFE", "AN_NFE"]
name="cheo_AF_NFE"
op="div2"
type="Float"

########################################################
## Latino
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_AMR", "gnomADg_AC_AMR"]
name="AC_AMR"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_AMR", "gnomADg_AN_AMR"]
name="AN_AMR"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_AMR", "AN_AMR"]
name="cheo_AF_AMR"
op="div2"
type="Float"

########################################################
## Ashkenazi Jewish
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_ASJ", "gnomADg_AC_ASJ"]
name="AC_ASJ"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_ASJ", "gnomADg_AN_ASJ"]
name="AN_ASJ"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_ASJ", "AN_ASJ"]
name="cheo_AF_ASJ"
op="div2"
type="Float"

########################################################
## EAST Asian
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_EAS", "gnomADg_AC_EAS"]
name="AC_EAS"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_EAS", "gnomADg_AN_EAS"]
name="AN_EAS"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_EAS", "AN_EAS"]
name="cheo_AF_EAS"
op="div2"
type="Float"

########################################################
## European (Finnish)
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_FIN", "gnomADg_AC_FIN"]
name="AC_FIN"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_FIN", "gnomADg_AN_FIN"]
name="AN_FIN"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_FIN", "AN_FIN"]
name="cheo_AF_FIN"
op="div2"
type="Float"

########################################################
## Other
########################################################
# Combined allele count AC
[[postannotation]]
fields=["gnomADe_AC_OTH", "gnomADg_AC_OTH"]
name="AC_OTH"
op="sum"
type="Integer"

# Combined allele number AN
[[postannotation]]
fields=["gnomADe_AN_OTH", "gnomADg_AN_OTH"]
name="AN_OTH"
op="sum"
type="Integer"

# Combined allele frequency AF
[[postannotation]]
fields=["AC_OTH", "AN_OTH"]
name="cheo_AF_OTH"
op="div2"
type="Float"

########################################################
## South Asians
########################################################
# Combined allele frequency AF computed from gnomad exome
[[postannotation]]
fields=["gnomADe_AC_SAS", "gnomADe_AN_SAS"]
name="cheo_AF_SAS"
op="div2"
type="Float"


################################################################
## Compute popmax allele frequency - max AF of all populations
###############################################################
[[postannotation]]
fields=["cheo_AF_AFR","cheo_AF_NFE","cheo_AF_AMR","cheo_AF_ASJ","cheo_AF_EAS","cheo_AF_FIN","cheo_AF_OTH","gnomADe_AF_SAS","cheo_AF_SAS"]
op="max"
name="cheo_AF_POPMAX"
type="Float"

# by Erinija, CHEO, June 2019
